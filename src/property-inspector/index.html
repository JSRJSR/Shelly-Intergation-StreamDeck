<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Shelly Toggle Configuration</title>
</head>
<body>
    <div class="sdpi-wrapper">
        <div class="sdpi-item">
            <div class="sdpi-item-label">IP Address</div>
            <input class="sdpi-item-value" type="text" id="ip-address" placeholder="192.168.1.100" />
        </div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">Device Generation</div>
            <select class="sdpi-item-value select" id="device-generation">
                <option value="auto">Auto-detect</option>
                <option value="gen1">Gen1</option>
                <option value="gen2">Gen2</option>
            </select>
        </div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">Component ID</div>
            <input class="sdpi-item-value" type="number" id="component-id" value="0" min="0" max="3" />
        </div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">Polling Interval (ms)</div>
            <input class="sdpi-item-value" type="number" id="polling-interval" value="5000" min="1000" step="1000" />
        </div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">Button Title</div>
            <input class="sdpi-item-value" type="text" id="button-title" placeholder="Custom title (optional)" />
        </div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">Show Status Text</div>
            <input class="sdpi-item-value" type="checkbox" id="show-status" checked />
        </div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">ON State Image</div>
            <input class="sdpi-item-value" type="text" id="on-state-image" placeholder="Path to ON image (optional)" />
        </div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">OFF State Image</div>
            <input class="sdpi-item-value" type="text" id="off-state-image" placeholder="Path to OFF image (optional)" />
        </div>

        <div class="sdpi-item">
            <button class="sdpi-item-value" id="test-connection">Test Connection</button>
        </div>
    </div>

    <script>
        (function() {
            'use strict';
            
            const $ = (id) => document.getElementById(id);
            let websocket = null;
            let settings = {};
            let uuid = null;

            const params = new URLSearchParams(window.location.search);
            const port = params.get('port');
            uuid = params.get('uuid');
            const registerEvent = params.get('registerEvent');
            const info = params.get('info');

            const loadSettings = () => {
                try {
                    if ($('ip-address')) $('ip-address').value = settings.ipAddress || '';
                    if ($('device-generation')) $('device-generation').value = settings.deviceGeneration || 'auto';
                    if ($('component-id')) $('component-id').value = settings.componentId !== undefined ? settings.componentId : 0;
                    if ($('polling-interval')) $('polling-interval').value = settings.pollingInterval !== undefined ? settings.pollingInterval : 5000;
                    if ($('button-title')) $('button-title').value = settings.buttonTitle || '';
                    if ($('show-status')) $('show-status').checked = settings.showStatus !== undefined ? settings.showStatus : true;
                    if ($('on-state-image')) $('on-state-image').value = settings.onStateImage || '';
                    if ($('off-state-image')) $('off-state-image').value = settings.offStateImage || '';
                } catch (error) {
                    console.error('Error loading settings:', error);
                }
            };

            const saveSettings = () => {
                try {
                    // Build settings object from form fields
                    settings.ipAddress = $('ip-address') ? $('ip-address').value.trim() : '';
                    settings.deviceGeneration = $('device-generation') ? $('device-generation').value : 'auto';
                    settings.componentId = $('component-id') ? parseInt($('component-id').value) || 0 : 0;
                    settings.pollingInterval = $('polling-interval') ? parseInt($('polling-interval').value) || 5000 : 5000;
                    settings.showStatus = $('show-status') ? $('show-status').checked : true;
                    
                    // Optional fields - delete if empty
                    const buttonTitle = $('button-title') ? $('button-title').value.trim() : '';
                    if (buttonTitle) {
                        settings.buttonTitle = buttonTitle;
                    } else {
                        delete settings.buttonTitle;
                    }
                    
                    const onStateImage = $('on-state-image') ? $('on-state-image').value.trim() : '';
                    if (onStateImage) {
                        settings.onStateImage = onStateImage;
                    } else {
                        delete settings.onStateImage;
                    }
                    
                    const offStateImage = $('off-state-image') ? $('off-state-image').value.trim() : '';
                    if (offStateImage) {
                        settings.offStateImage = offStateImage;
                    } else {
                        delete settings.offStateImage;
                    }

                    // Send settings immediately if WebSocket is ready
                    if (websocket && websocket.readyState === WebSocket.OPEN && uuid) {
                        const json = {
                            event: 'setSettings',
                            context: uuid,
                            payload: settings,
                        };
                        websocket.send(JSON.stringify(json));
                        console.log('Settings saved:', settings);
                    } else {
                        console.warn('Settings not saved - WebSocket not ready. State:', websocket ? websocket.readyState : 'null', 'UUID:', uuid);
                    }
                } catch (error) {
                    console.error('Error saving settings:', error);
                }
            };

            const setupEventListeners = () => {
                try {
                    const inputs = ['ip-address', 'device-generation', 'component-id', 'polling-interval', 
                                   'button-title', 'show-status', 
                                   'on-state-image', 'off-state-image'];
                    
                    inputs.forEach(id => {
                        const element = $(id);
                        if (element) {
                            // Save immediately on all change events
                            element.addEventListener('change', () => saveSettings());
                            element.addEventListener('blur', () => saveSettings());
                            // Also save on input events for immediate feedback (especially for text fields)
                            if (element.type !== 'checkbox') {
                                element.addEventListener('input', () => saveSettings());
                            }
                        }
                    });

                    if ($('test-connection')) {
                        $('test-connection').addEventListener('click', async () => {
                            const ip = $('ip-address') ? $('ip-address').value : '';
                            if (!ip) {
                                alert('Please enter an IP address');
                                return;
                            }
                            try {
                                let response = await fetch(`http://${ip}/rpc/Shelly.GetDeviceInfo`);
                                if (response.ok) {
                                    const data = await response.json();
                                    alert(`Connected! Device: ${data.model || 'Unknown'} (Gen2)`);
                                    return;
                                }
                                response = await fetch(`http://${ip}/shelly`);
                                if (response.ok) {
                                    const data = await response.json();
                                    alert(`Connected! Device: ${data.type || 'Unknown'} (Gen1)`);
                                    return;
                                }
                                alert('Connection failed');
                            } catch (error) {
                                alert('Connection failed: ' + error.message);
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error setting up event listeners:', error);
                }
            };

            const connectElgatoStreamDeckSocket = (inPort, inUUID, inRegisterEvent, inInfo, inActionInfo) => {
                uuid = inUUID;

                websocket = new WebSocket(`ws://localhost:${inPort}`);
                
                websocket.onopen = () => {
                    console.log('WebSocket connected');
                    const json = {
                        event: inRegisterEvent,
                        uuid: inUUID
                    };
                    websocket.send(JSON.stringify(json));
                    
                    // Request current settings
                    const getSettingsJson = {
                        event: 'getSettings',
                        context: inUUID
                    };
                    websocket.send(JSON.stringify(getSettingsJson));
                };

                websocket.onmessage = (evt) => {
                    try {
                        const jsonObj = JSON.parse(evt.data);
                        if (jsonObj.event === 'didReceiveSettings') {
                            settings = jsonObj.payload.settings || {};
                            loadSettings();
                            console.log('Settings loaded:', settings);
                        }
                    } catch (error) {
                        console.error('Error processing WebSocket message:', error);
                    }
                };

                websocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };

                websocket.onclose = (event) => {
                    console.log('WebSocket closed', event.code, event.reason);
                    // Attempt to save settings one last time before closing
                    saveSettings();
                };
            };

            // Save settings when property inspector is about to close
            window.addEventListener('beforeunload', () => {
                saveSettings();
            });

            // Save settings when property inspector loses visibility (backup)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    saveSettings();
                }
            });

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    setupEventListeners();
                    if (port && uuid) {
                        connectElgatoStreamDeckSocket(port, uuid, registerEvent || 'propertyInspectorDidAppear', info, null);
                    }
                });
            } else {
                setupEventListeners();
                if (port && uuid) {
                    connectElgatoStreamDeckSocket(port, uuid, registerEvent || 'propertyInspectorDidAppear', info, null);
                }
            }
        })();
    </script>
</body>
</html>
